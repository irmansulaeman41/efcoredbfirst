# Description
Entity Framework Core DB First Approach. This project using ASP .NET Core Web API project template with modification. Using Entity Framework Core for object-database mapper (ORM).

# Project Content
Project Content using default ASP .NET Core Web API project template with some additional and modification.  
1. config  
This directory contain appsettings.json moved from app root directory.
2. DataAccess  
This directory contain ApplicationDbContext
3. Models  
This directory contains Entities and ViewModel. **Entities** contains database entities generated using database scaffolding. **ViewModel** contains view model class.

![ProjectStructure](images/ProjectStructure_1.jpg?raw=true)

## appsettings.json
Move appsettings.json from project root directory to config directory. Update appsettings.json :  
    
    {
        "Logging": {
            "LogLevel": {
            "Default": "Information",
            "Microsoft": "Warning",
            "Microsoft.Hosting.Lifetime": "Information"
            }
        },
        "ConnectionStrings": {
            "AppConnStr": "Data Source=.;initial catalog=EFCoreDemo;user id=sa;password=P@ssw0rd"
        },
        "AllowedHosts": "*"
    }

## Program.cs
Update Program.cs :

    public class Program
    {
        public static void Main(string[] args)
        {
            CreateHostBuilder(args).Build().Run();
        }

        public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration(c => {
                    c.AddJsonFile("config/appsettings.json", optional: true, reloadOnChange: true);
                })
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder.UseStartup<Startup>();
                });
    }

## WeatherForecast
This controller generated by visual studio project template (ASP .NET Core Web Api). By default, this controller use WeatherForecast model (project root folder). We need to organize folder structure like this :

![OrganizeModels](images/OrganizeModels.jpg?raw=true)


Update WeatherForecast.cs

    public class WeatherForecastViewModel
    {
        public DateTime Date { get; set; }

        public int TemperatureC { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public string Summary { get; set; }
    }

Update WeatherForecastController.cs on Get Method :

        [HttpGet]
        public IEnumerable<WeatherForecastViewModel> Get()
        {
            var rng = new Random();
            return Enumerable.Range(1, 5).Select(index => new WeatherForecastViewModel
            {
                Date = DateTime.Now.AddDays(index),
                TemperatureC = rng.Next(-20, 55),
                Summary = Summaries[rng.Next(Summaries.Length)]
            })
            .ToArray();
        }

## Database Scaffold
1. Open Package Manager Console
2. Install nugget package :

        Install-Package Microsoft.EntityFrameworkCore.SqlServer
        Install-Package Microsoft.EntityFrameworkCore.Tools
        Install-Package Microsoft.EntityFrameworkCore.Design

3. Database Scaffold (Entity Framework) using this command :

        dotnet ef dbcontext scaffold "Data Source=.;initial catalog=EFCoreDemo;user id=sa;password=P@ssw0rd" Microsoft.EntityFrameworkCore.SqlServer -o Models/Entities -n efcodefirstapi.Models --context-dir DataAccess -c ApplicationDbContext -p "efcodefirstapi\efcodefirstapi.csproj"

4. ApplicationDbContext and Entities will be generated on specify directory.

    ![DbScaffold1](images/DbScaffold.jpg?raw=true)

    Update namespace for ApplicationDbContext to **efcodefirstapi.DataAccess**  
    Update **OnConfiguring** method :

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            if (!optionsBuilder.IsConfigured)
            {
                //#warning To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263.
                //                optionsBuilder.UseSqlServer("Data Source=.;initial catalog=EFCoreDemo;user id=sa;password=P@ssw0rd");
            }
        }

## Startup.cs
Update Startup.cs on ConfigureServices method :

        public void ConfigureServices(IServiceCollection services)
        {
            var sqlConnectionString = Configuration.GetConnectionString("AppConnStr");
            services.AddDbContext<ApplicationDbContext>(options => options.UseSqlServer(sqlConnectionString));

            services.AddControllers();
            services.AddSwaggerGen(c =>
            {
                c.SwaggerDoc("v1", new OpenApiInfo { Title = "efcodefirstapi", Version = "v1" });
            });
        }

## Sample Command Controller

Now, we have project structure that we need. Next we create sample controller to use ApplicationDbContext (**CommandController**).  
1. Create New Class **CommandController** inside **Controllers** directory
2. Update **CommandController** content

        [ApiController]
        [Route("[controller]")]
        public class CommandController : ControllerBase
        {
            private readonly ILogger<CommandController> _logger;
            private readonly ApplicationDbContext _dbcontext;

            public CommandController(ILogger<CommandController> logger, ApplicationDbContext dbcontext)
            {
                _logger = logger;
                _dbcontext = dbcontext;
            }

            [HttpGet]
            public IEnumerable<CommandViewModel> Get()
            {
                return _dbcontext.Commands.Select(d => new CommandViewModel()
                {
                    CommandLine = d.CommandLine,
                    HowTo = d.HowTo,
                    Id = d.Id,
                    PlatformId = d.PlatformId,
                    PlatformLicenseKey = d.Platform.LicenseKey,
                    PlatformName = d.Platform.Name
                }).ToList();
            }
        }

    Make sure use this namespace on using section : 

        using efcodefirstapi.DataAccess;
        using efcodefirstapi.Models.ViewModel;

Run Apps for testing :

![RunApps1](images/RunApps1.jpg?raw=true)
![RunApps2](images/RunApps2.jpg?raw=true)